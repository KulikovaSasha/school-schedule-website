{% extends "base.html" %}

{% block extra_css %}
<style>
    .schedule-form {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        font-weight: bold;
        margin-bottom: 0.5rem;
        display: block;
        color: #2c3e50;
    }

    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s ease;
    }

    .form-control:focus {
        border-color: #4CAF50;
        outline: none;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .days-checkbox {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background-color: #f8f9fa;
    }

    .form-check {
        display: flex;
        align-items: center;
        padding: 8px;
        background: white;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }

    .form-check:hover {
        border-color: #4CAF50;
        background-color: #f8fff8;
    }

    .form-check-input {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }

    .form-check-label {
        cursor: pointer;
        font-weight: normal;
        margin-bottom: 0;
    }

    .form-text {
        font-size: 14px;
        color: #6c757d;
        margin-top: 5px;
    }

    .error {
        color: #dc3545;
        font-size: 14px;
        margin-top: 5px;
    }

    .btn-group {
        display: flex;
        gap: 15px;
        margin-top: 2rem;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }

    .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
    }

    .btn-primary {
        background-color: #4CAF50;
        color: white;
    }

    .btn-primary:hover {
        background-color: #45a049;
        transform: translateY(-2px);
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 1.5rem;
    }

    .form-row .form-group {
        margin-bottom: 0;
    }

    h2 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 2rem;
        font-size: 2rem;
        font-weight: bold;
    }

    .time-info {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #4CAF50;
    }

    .time-info p {
        margin: 5px 0;
        color: #2c3e50;
        font-size: 14px;
    }

    .lessons-preview {
        background: #fff3cd;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #ffc107;
        display: none;
    }

    .lessons-preview h4 {
        margin: 0 0 10px 0;
        color: #856404;
    }

    .lessons-list {
        font-size: 14px;
        color: #856404;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        .schedule-form {
            margin: 10px;
            padding: 15px;
        }

        .days-checkbox {
            grid-template-columns: 1fr;
        }

        .form-row {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .btn-group {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2>üìÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h2>

    <form method="POST" class="schedule-form">
        {{ form.hidden_tag() }}

        <div class="form-group">
            {{ form.title.label }}
            {{ form.title(class="form-control", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å–µ–Ω–Ω–∏–π —Å–µ–º–µ—Å—Ç—Ä 10–ê –∫–ª–∞—Å—Å–∞") }}
            {% if form.title.errors %}
                <div class="error">{{ form.title.errors[0] }}</div>
            {% endif %}
            <small class="form-text">–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</small>
        </div>

        <div class="form-group">
            {{ form.days_of_week.label(class="form-label") }}
            <div class="days-checkbox">
                {% for value, label in form.days_of_week.choices %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="days_of_week"
                           value="{{ value }}" id="day_{{ value }}"
                           {% if value in form.days_of_week.data %}checked{% endif %}>
                    <label class="form-check-label" for="day_{{ value }}">
                        {{ label }}
                    </label>
                </div>
                {% endfor %}
            </div>
            {% for error in form.days_of_week.errors %}
                <span class="text-danger">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="time-info">
            <p><strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏:</strong></p>
            <p>‚Ä¢ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ —É—Ä–æ–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç <strong>60 –º–∏–Ω—É—Ç</strong></p>
            <p>‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–∫–æ–≤ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞</p>
            <p>‚Ä¢ –ü—Ä–∏–º–µ—Ä: —Å 08:30 –¥–æ 14:30 = 6 —É—Ä–æ–∫–æ–≤ –ø–æ 60 –º–∏–Ω—É—Ç</p>
            <p>‚Ä¢ <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –≤—Ä–µ–º—è –æ–∫—Ä—É–≥–ª—è–µ—Ç—Å—è –≤ –±–æ–ª—å—à—É—é —Å—Ç–æ—Ä–æ–Ω—É. –ù–∞–ø—Ä–∏–º–µ—Ä, —Å 8:00 –¥–æ 9:30 = 2 —É—Ä–æ–∫–∞</p>
        </div>

        <div class="lessons-preview" id="lessonsPreview">
            <h4>üìä –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç:</h4>
            <div class="lessons-list" id="lessonsList"></div>
        </div>

        <div class="form-row">
            <div class="form-group">
                {{ form.start_time.label }}
                {{ form.start_time(class="form-control", placeholder="09:00", value="08:30") }}
                {% if form.start_time.errors %}
                    <div class="error">{{ form.start_time.errors[0] }}</div>
                {% endif %}
                <small class="form-text">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–∫–∞</small>
            </div>

            <div class="form-group">
                {{ form.end_time.label }}
                {{ form.end_time(class="form-control", placeholder="15:00", value="14:30") }}
                {% if form.end_time.errors %}
                    <div class="error">{{ form.end_time.errors[0] }}</div>
                {% endif %}
                <small class="form-text">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—Ä–æ–∫–∞</small>
            </div>
        </div>

        <div class="btn-group">
            {{ form.submit(class="btn btn-primary") }}
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const defaultDays = ['mon', 'tue', 'wed', 'thu', 'fri'];
    defaultDays.forEach(day => {
        const checkbox = document.getElementById('day_' + day);
        if (checkbox) {
            checkbox.checked = true;
        }
    });

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const startTimeInput = document.querySelector('select[name="start_time"]');
    const endTimeInput = document.querySelector('select[name="end_time"]');
    const lessonsPreview = document.getElementById('lessonsPreview');
    const lessonsList = document.getElementById('lessonsList');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Ä–æ–∫–æ–≤
    function calculateAndDisplayLessons() {
        if (!startTimeInput || !endTimeInput) return;

        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;

        if (startTime && endTime) {
            const start = new Date('2000-01-01T' + startTime + ':00');
            const end = new Date('2000-01-01T' + endTime + ':00');

            if (end <= start) {
                // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤—Ä–µ–º–µ–Ω–∏
                lessonsPreview.style.display = 'none';
                return false;
            }

            // –†–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—Ä–æ–∫–æ–≤ (–æ–∫—Ä—É–≥–ª—è–µ–º –≤–≤–µ—Ä—Ö)
            const diffMs = end - start;
            const diffMinutes = diffMs / (1000 * 60);
            const lessonsCount = Math.ceil(diffMinutes / 60); // –û–∫—Ä—É–≥–ª—è–µ–º –≤–≤–µ—Ä—Ö
            const actualLessonsCount = Math.max(1, lessonsCount);

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø—Ä–µ–≤—å—é
            lessonsPreview.style.display = 'block';

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤
            let lessonsHTML = `<p>–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ <strong>${actualLessonsCount}</strong> —É—Ä–æ–∫–æ–≤:</p>`;
            lessonsHTML += '<ol style="margin-left: 20px;">';

            for (let i = 0; i < actualLessonsCount; i++) {
                const lessonStart = new Date(start.getTime() + i * 60 * 60 * 1000);
                const lessonEnd = new Date(lessonStart.getTime() + 60 * 60 * 1000);

                const startStr = lessonStart.toTimeString().substring(0, 5);
                const endStr = lessonEnd.toTimeString().substring(0, 5);

                lessonsHTML += `<li>${startStr} - ${endStr}</li>`;
            }

            lessonsHTML += '</ol>';
            lessonsList.innerHTML = lessonsHTML;

            console.log(`üìä –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ ${actualLessonsCount} —É—Ä–æ–∫–æ–≤ –ø–æ 60 –º–∏–Ω—É—Ç`);
            return true;
        }

        lessonsPreview.style.display = 'none';
        return false;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    if (startTimeInput) {
        startTimeInput.addEventListener('change', calculateAndDisplayLessons);
    }

    if (endTimeInput) {
        endTimeInput.addEventListener('change', calculateAndDisplayLessons);
    }

    // –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏
    const dayLabels = document.querySelectorAll('.form-check-label');
    dayLabels.forEach(label => {
        label.addEventListener('mouseenter', function() {
            this.style.color = '#4CAF50';
            this.style.fontWeight = 'bold';
        });

        label.addEventListener('mouseleave', function() {
            this.style.color = '';
            this.style.fontWeight = 'normal';
        });
    });

    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    setTimeout(calculateAndDisplayLessons, 100);
});
</script>
{% endblock %}